# 1. Утилита обработки видео с использованием YOLOv10

detect_segments.py

Утилита предназначена для обработки видеофайлов с использованием модели YOLOv10 для обнаружения объектов. Извлекает кадры из видео, применяет детекцию объектов и сохраняет результаты.

## Основные функции

- Извлечение кадров из видео с заданной частотой
- Обнаружение объектов на кадрах с помощью YOLOv10
- Фильтрация обнаруженных объектов по классу и уверенности
- Сохранение результатов в виде сегментов видео и детальной информации
- Опциональное сохранение обработанных кадров и обрезанных изображений объектов

## Параметры

- `--source`: Папка с исходными видеофайлами (по умолчанию: "c:\video")
- `--fps`: Частота извлечения кадров (кадры в секунду, по умолчанию: 0.1)
- `--device`: Устройство для обработки (cpu или cuda, по умолчанию: cpu)
- `--segments`: Файл для сохранения результатов сегментов (по умолчанию: segments.txt)
- `--results`: Файл для сохранения детальных результатов (по умолчанию: results.json)
- `--class_id`: ID класса YOLO для фильтрации объектов (по умолчанию: 0)
- `--save_images`: Флаг для сохранения обработанных кадров
- `--save_boxes`: Флаг для сохранения обрезанных областей с обнаруженными объектами
- `--model_weights`: Путь к весам модели YOLOv10 (по умолчанию: yolov10s.pt)
- `--confidence`: Минимальный порог уверенности для фильтрации объектов (по умолчанию: 0.7)
- `--border`: Процент увеличения границы вокруг обнаруженного объекта (по умолчанию: 0.20)
- `--gap`: Допустимый промежуток между кадрами для сегментации, в секундах (по умолчанию: 20)

Утилита обрабатывает все видеофайлы в указанной папке, применяет детекцию объектов и сохраняет результаты в заданные файлы.

## Использование

```bash
python utils\detect_segments.py --source d:/video/new --fps 0.1 --device cuda --segments segments.txt --results details.json --class_id 0 --model_weights yolov10s.pt --confidence 0.7 --border 0.20 --gap 20
```

# 2. Утилита обработки видеосегментов

process_segments.py

Эта утилита предназначена для обработки и фильтрации данных сегментов видео, полученных после детекции объектов. Она читает файл с информацией о сегментах, фильтрует их по заданной минимальной длительности и создает новый файл с отфильтрованными данными.

## Основные функции

- Чтение файла с информацией о сегментах видео
- Фильтрация сегментов по минимальной длительности
- Создание нового файла с отфильтрованными сегментами
- Перемещение файлов без подходящих сегментов в отдельную папку

## Параметры

- `--segments`: Путь к исходному файлу с сегментами (по умолчанию: "segments.txt")
- `--delete_folder`: Папка для перемещения файлов без подходящих сегментов (по умолчанию: "delete_files/")
- `--newsegments`: Файл для записи отфильтрованных сегментов (по умолчанию: "segments_split.txt")
- `--mintime`: Минимальная длительность сегмента в секундах (по умолчанию: 300)

## Использование

```bash
python utils\process_segments.py --segments segments.txt --delete_folder d:/video/deleted --newsegments segments_split.txt --mintime 300
```

Утилита обрабатывает входной файл с сегментами, удаляет сегменты короче указанной длительности, перемещает файлы без подходящих сегментов в указанную папку и сохраняет результаты в новый файл.

# 3. Утилита для извлечения видеосегментов

extract_segments.py

Эта утилита предназначена для быстрого извлечения сегментов из видеофайлов на основе предварительно обработанных данных детекции объектов. Она читает информацию о сегментах из текстового файла, извлекает соответствующие фрагменты видео и сохраняет их как отдельные файлы.

## Основные функции

- Чтение информации о видеосегментах из текстового файла
- Извлечение указанных сегментов из исходных видеофайлов
- Сохранение извлеченных сегментов как отдельных видеофайлов
- Возможность указать целевую папку для сохранения результатов

## Параметры

- `--segments`: Путь к файлу с информацией об обработанных сегментах (по умолчанию: "segments_split.txt")
- `--target_folder`: Путь к папке для сохранения извлеченных видеосегментов (необязательный параметр)

## Формат файла с сегментами

Файл с сегментами должен иметь следующий формат:

```txt
"путь_к_видео",начало1:длительность1,начало2:длительность2,...
```

Например:

```txt
"c:\videos\video1.mp4",10:30,50:20,100:45
```

Утилита обрабатывает все видеофайлы, указанные в файле сегментов, извлекает соответствующие фрагменты и сохраняет их в исходной или указанной целевой папке.

## Пример использования

```bash
python utils\extract_segments.py --segments segments_split.txt --target_folder d:/video/clips
```

Вот пример использования программы VideoFileSorter для README.md на русском языке:

# 4. Сортировщик видеофайлов

`sort_clips.py` - это утилита для организации видеофайлов по папкам на основе информации о камере и дате, извлеченной из имен файлов.

## Возможности

- Извлекает информацию о камере и дате из имен видеофайлов
- Создает структуру папок на основе камеры и даты
- Перемещает видеофайлы в соответствующие папки
- Поддерживает аргументы командной строки для гибкого использования

## Использование

```bash
python utils\sort_clips.py --source_folder d:/video/clips --target_folder d:/video/sorted
```

### Параметры

- `--source_folder`: Путь к папке с несортированными видеофайлами (обязательный)
- `--target_folder`: Путь к папке, куда будут перемещены отсортированные файлы (обязательный)

## Пример

Предположим, у вас есть видеофайлы в формате `cam-901-2023-05-15-120000.mp4` в папке `/video/clips`. Чтобы отсортировать эти файлы в структурированную иерархию папок, выполните:

```bash
sort_clips.py --source_folder /video/clips --target_folder /video/sorted
```

Это создаст структуру папок следующего вида:

```
/video/sorted
├── cam-901/
│   └── 2023-05-15/
│       └── cam-901-2023-05-15-120000.mp4
├── cam-1001/
│   └── 2023-05-16/
│       └── cam-1001-2023-05-16-130000.mp4
...
```

Скрипт переместит каждый видеофайл в соответствующую папку на основе номера камеры и даты, извлеченных из имени файла.

# 5. Утилита для извлечения кадров из видео

extract_frames.py

Эта утилита предназначена для извлечения кадров из видеофайлов с заданной частотой и сохранения их в виде изображений.

## Основные функции

- Обработка видеофайлов из указанной папки
- Извлечение кадров с заданной частотой
- Сохранение кадров в формате PNG
- Создание текстового файла с информацией о извлеченных кадрах
- Опциональная обработка подпапок

## Параметры

- `--source_folder`: Исходная папка с видеофайлами (по умолчанию: "d:/video/sorted")
- `--target_folder`: Папка для сохранения извлеченных кадров (по умолчанию: "d:/video/results")
- `--fps`: Частота извлечения кадров (по умолчанию: 1.0)
- `--subfolders`: Сканировать входную папку с подпапками (по умолчанию: True)

## Использование

```bash
python utils\extract_frames.py --source_folder d:/video/sorted --target_folder d:/video/results --fps 0.02 --subfolders True
```

## Результаты

- Извлеченные кадры сохраняются в формате PNG в указанной выходной папке
- Создается файл `frames.txt` с информацией о извлеченных кадрах в формате:
  
  ```txt
  "имя_видео.mp4", "имя_видео.001.png"
  "имя_видео.mp4", "имя_видео.002.png"
  ...
  ```

Утилита обрабатывает все видеофайлы в указанной папке, извлекает кадры с заданной частотой и сохраняет результаты в выходной папке, сохраняя структуру подпапок при необходимости.

# 6. Детектор объектов на видео с использованием YOLOv10 и Microsoft Florence-2

`detect_florence.py` - это утилита для обработки видеофайлов с использованием моделей YOLOv10 и Microsoft Florence-2 для обнаружения и анализа объектов.

## Основные возможности

- Извлечение кадров из видео с заданной частотой
- Обнаружение объектов на кадрах с помощью YOLOv10
- Анализ обнаруженных объектов с использованием Microsoft Florence-2
- Фильтрация результатов по классу и уверенности
- Сохранение результатов в JSON-формате и изображений
- Создание отдельных папок для каждого обрабатываемого видео

## Параметры

- `--source_folder`: Директория с входными видеофайлами (обязательный)
- `--target_folder`: Директория для сохранения результатов (обязательный)
- `--yolo_model`: Путь к весам модели YOLO (по умолчанию: "yolov10s.pt")
- `--florence_model`: Название или путь к модели Florence (по умолчанию: "microsoft/Florence-2-large")
- `--yolo_id`: ID класса YOLO для детекции (по умолчанию: 0). Если yolo_id = -1, то детекция YOLO не используется, а для работы с florence передается все изображение.
- `--general_prompt`: Общий промпт для детекции (обязательный)
- `--class_prompts`: Промпты для классов в формате "class_id=prompt" (обязательный)
- `--device`: Устройство для вычислений (cpu или cuda, по умолчанию: "cpu")
- `--fps`: Кадров в секунду для детекции (по умолчанию: 0.1)
- `--confidence`: Минимальная уверенность для детекций YOLO (по умолчанию: 0.7)
- `--border`: Процент увеличения размера ограничивающей рамки (по умолчанию: 0.20)
- `--query`: Запрос к модели Microsoft Florence (по умолчанию: "<CAPTION_TO_PHRASE_GROUNDING>"). Возможны также "<CAPTION>", "<DETAILED_CAPTION>", "<MORE_DETAILED_CAPTION>".

- `--mode`: Режим обработки: video или images (по умолчанию: "images")
- `--subfolder`: Обрабатывать подпапки во входной директории (по умолчанию: True)
- `--forcemask`: Список файловых масок для принудительной обработки (например 'VID_20240627_110044.' или \*VID_20240627_110044\*)
- `--save_original`: Сохранять оригинальные изображения (по умолчанию: True)
- `--save_yolo`: Сохранять боксы из результатов YOLO (по умолчанию: False)
- `--save_boxes`: Сохранять боксы из результатов Florence (по умолчанию: False)
- `--draw_boxes`: Рисовать боксы из результатов Florence (по умолчанию: False)
- `--scale`: Масштабирование изображений перед обработкой (по умолчанию: 1)
- `--verbose`: Выводить отладочную информацию YOLO (по умолчанию: False)

## Использование

```bash
python utils\detect_florence.py --source_folder c:/video/2024-05-10 --target_folder c:/video/florence --general_prompt "locate gloves on people hands" --class_prompts "0=locate gloves" "1=locate people" "2=locate hands" --mode "images" --save_boxes --device cpu
```

Программа обрабатывает все видеофайлы или изображения в указанной директории, применяет детекцию объектов с помощью YOLOv10 и анализирует результаты с использованием Microsoft Florence-2. Результаты сохраняются в отдельных папках для каждого видео или набора изображений, включая JSON-файлы с детальной информацией и изображения обнаруженных объектов.

# 7. Утилита для копирования файлов с фильтрацией

`copy_files.py`

Эта утилита предназначена для копирования файлов из одной папки в другую, игнорируя файлы, находящиеся в заданных папках, и фильтруя их по маске.

## Основные функции

- Сканирование исходной папки по заданной маске
- Игнорирование файлов, находящихся в указанных папках
- Копирование файлов в целевую папку
- Логирование копирования и пропуска файлов

## Параметры

- `--source_folder`: Путь к исходной папке (по умолчанию: "florence")
- `--target_folder`: Путь к целевой папке (по умолчанию: "florence.new")
- `--ignore_folders`: Список папок для игнорирования файлов (по умолчанию: ["florence.good", "florence.bad"])
- `--mask`: Маска для сканирования файлов (по умолчанию: "*.florence.*")

Утилита сканирует все файлы в исходной папке `--source_folder`, фильтрует их по маске `--mask` и проверяет, находятся ли эти файлы в папках из списка `--ignore_folders`. Список игнорируемых файлов загружается один раз перед началом копирования.

Файлы, которые не находятся в папках из списка `--ignore_folders`, копируются в целевую папку `--target_folder`. В процессе копирования утилита показывает, какие файлы были скопированы, а какие пропущены.

## Использование

```bash
python utils\copy_files.py --source_folder c:/proplex/florence --target_folder c:/proplex/florence.new --ignore_folders c:/proplex/florence.good c:/proplex/florence.bad --mask *.florence.*
```

Этот пример сканирует папку `c:/proplex/florence` на наличие файлов, соответствующих маске `*.florence.*`, игнорирует файлы из папок `c:/proplex/florence.good` и `c:/proplex/florence.bad`, и копирует найденные файлы в папку `c:/proplex/florence.new`.

# 8. Утилита создания YOLO датасета

create_dataset.py

Эта утилита предназначена для создания датасета в формате YOLO из изображений и аннотаций, полученных от модели Microsoft Florence.

### Основные функции

- Чтение изображений и аннотаций из заданных папок
- Конвертация формата ограничивающих рамок из Florence в формат YOLO
- Разделение данных на тренировочный и валидационный наборы
- Сохранение изображений и аннотаций в соответствующие папки

### Параметры

- `--source_folder`: Путь к исходной папке с аннотациями и оригинальными изображениями (по умолчанию: "c:\proplex\florence")
- `--data_folder`: Путь к папке с отфильтрованными изображениями (по умолчанию: "c:\proplex\florence.good")
- `--dataset_folder`: Путь к папке для сохранения созданного датасета (по умолчанию: "c:\proplex\dataset")
- `--class_id`: Идентификатор класса для YOLO (по умолчанию: 0)
- `--valid`: Процент данных для валидации (по умолчанию: 20)

### Пример структуры папок

```txt
dataset/
├── train/
│   ├── images/
│   └── labels/
└── valid/
    ├── images/
    └── labels/
```

## Использование

Для запуска утилиты используйте команду:

```bash
python utils\create_dataset.py --source_folder c:/proplex/florence --data_folder c:/proplex/florence.good --dataset_folder c:/proplex/dataset --class_id 0 --valid 20
```

Эта команда запустит процесс создания датасета, в ходе которого изображения и аннотации будут преобразованы и сохранены в соответствующие папки, разделенные на тренировочные и валидационные наборы.

# 9. Утилита для фильтрации и копирования файлов JSON и изображений

`filter_labels.py`

Эта утилита предназначена для поиска файлов JSON в указанной папке, фильтрации их по меткам и копирования соответствующих изображений в целевую папку.

## Основные функции

- Сканирование указанной папки на наличие файлов JSON
- Фильтрация меток в JSON файлах по заданным критериям
- Копирование изображений, соответствующих отфильтрованным меткам, в целевую папку

## Параметры

- `--source_folder`: Путь к исходной папке с файлами JSON и изображениями (по умолчанию: "florence")
- `--target_folder`: Путь к папке для сохранения скопированных изображений (по умолчанию: "florence.new")
- `--label_filter`: Список фильтров для меток (по умолчанию: ["text label", "inscription"])
- `--extract`: Вырезать изображения по bounding box (по умолчанию: False)

Утилита сканирует все файлы JSON в исходной папке , проверяет метки в JSON файлах и, если метка соответствует любому из значений, заданных в фильтре, копирует соответствующее изображение в целевую папку.

## Использование

```bash
python utils\filter_labels.py --source_folder c:/proplex/labels.florence --target_folder c:/proplex/labels.new --label_filter "text label" "inscription" --extract
```

Этот пример сканирует папку `c:/proplex/florence` на наличие файлов JSON, фильтрует метки в JSON файлах по значениям "text label" и "inscription", и копирует изображения, соответствующие отфильтрованным меткам, в папку `c:/proplex/florence.new`.
